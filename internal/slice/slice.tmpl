{{/* gotype: github.com/ns1/jsonschema2go.slicePlanContext */}}
{{ if .Comment -}}
// {{ .Comment }}
{{ end -}}
{{ if .ID -}}
// generated from {{ .ID }}
{{ end -}}
type {{ .Type.Name }} []{{ $.QualName .ItemType }}

func (m {{ .Type.Name }}) MarshalJSON() ([]byte, error) {
    if m == nil {
        return []byte(`[]`), nil
    }
    return json.Marshal([]{{ $.QualName .ItemType }}(m))
}

{{ if .ItemValidateInitialize }}
var (
{{ range .ItemValidators -}}
{{ with $v := .Var (.NameSpace $.Type.Name "Items") -}}
    {{ $v }}
{{ end -}}
{{ end -}}
)
{{ end -}}

func (m {{ $.Type.Name }}) Validate() error {
{{ range .Validators -}}
{{ if eq .Name "uniqueItems" -}}
    seen := make(map[{{$.QualName $.ItemType}}]bool)
    for i, v := range m {
        if seen[v] {
            return &validationError{
                errType: "uniqueItems",
                message: fmt.Sprintf("items must be unique but %v occurs more than once", v),
                path: []interface{}{i},
                jsonPath: []interface{}{i},
            }
        }
        seen[v] = true
    }
{{ else -}}
	if {{ .Test (.NameSpace $.Type.Name) "m" }} {
		return &validationError{
			errType: "{{ .Name }}",
			message: fmt.Sprintf({{ .Sprintf (.NameSpace $.Type.Name) "m" }}),
		}
	}
{{ end -}}
{{ end -}}
{{ with .ItemValidators -}}
    for i := range m {
        {{ range . -}}
        {{ if eq .Name "subschema" -}}
        if err := m[i].Validate(); err != nil {
            if err, ok := err.(valErr); ok {
                return &validationError{
                    errType: err.ErrType(),
                    message: err.Message(),
                    path: append([]interface{}{i}, err.Path()...),
                    jsonPath: append([]interface{}{i}, err.JSONPath()...),
                }
            }
            return err
        }
        {{ else -}}
        if {{ .Test (.NameSpace $.Type.Name "Items") "m[i]" }} {
            return &validationError{
                errType: "{{ .Name }}",
                message: fmt.Sprintf({{ .Sprintf (.NameSpace $.Type.Name "Items") "m[i]" }}),
                path: []interface{}{i},
                jsonPath: []interface{}{i},
            }
        }
        {{ end -}}
        {{ end -}}
    }
{{ end -}}
	return nil
}
